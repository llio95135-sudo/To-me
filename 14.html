<!doctype html>

<html lang="zh-Hant">

<head>

  <meta charset="utf-8" />

  <title>æ’ç­ç³»çµ±ï¼ˆFullCalendarï¼‰</title>



  <!-- FullCalendar -->

  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>



  <style>

    body{font-family:system-ui, "Noto Sans TC";margin:0;background:#f5f7fb;color:#111}

    header{background:#0b74ff;color:#fff;padding:12px 16px;display:flex;align-items:center}

    header h1{margin:0;font-size:18px}

    .wrap{display:flex;gap:16px;padding:16px}

    .left{width:320px}

    .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 1px 6px rgba(10,20,40,0.06);margin-bottom:12px}

    input,select,button,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;box-sizing:border-box}

    button{background:#0b74ff;color:white;border:none;padding:8px;border-radius:8px;cursor:pointer}

    .muted{color:#666;font-size:13px}

    #calendar{flex:1}

    .green{background:#4CAF50}

    .blue{background:#2196F3}

    .row{display:flex;gap:8px}

    .small{font-size:13px;color:#666}

    .danger{background:#ff4d4f}

    .tag{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef3ff;color:#0b74ff;margin-right:6px;font-size:12px}

  </style>

</head>

<body>



<header><h1>æ’ç­ç³»çµ±ï¼ˆFullCalendarï¼‰</h1><div style="margin-left:auto" id="userInfo" class="small"></div></header>



<div class="wrap">

  <div class="left">

    <div class="card" id="authCard">

      <div id="authForms">

        <h3>ç™»å…¥ / è¨»å†Š</h3>

        <label>Email</label><input id="email" placeholder="email@example.com" />

        <label>å¯†ç¢¼</label><input id="password" type="password" />

        <div class="row" style="margin-top:8px">

          <button id="btnLogin">ç™»å…¥</button>

        </div>

        <div class="small" style="margin-top:8px">åªæœ‰ä¸»ç®¡å¸³è™Ÿå¯ä»¥è¨»å†Šæ–°å¸³è™Ÿã€‚è«‹è¯ç¹«ä¸»ç®¡å”åŠ©è¨»å†Šã€‚</div>

      </div>



      <div id="registerForm" style="display:none">

        <h3>è¨»å†Š</h3>

        <label>å§“å</label><input id="regName" />

        <label>Email</label><input id="regEmail" />

        <label>å¯†ç¢¼</label><input id="regPassword" type="password" />

        <div class="row" style="margin-top:8px">

          <button id="btnRegister">è¨»å†Š</button>

          <button id="btnShowLogin" class="small">å›ç™»å…¥</button>

        </div>

      </div>



      <div id="afterLogin" style="display:none">

        <div class="small">ä½ å·²ç™»å…¥ï¼š<strong id="meName"></strong>ï¼ˆ<span id="meRole"></span>ï¼‰</div>

        <div style="margin-top:8px" class="row">

          <button id="btnLogout" class="small">ç™»å‡º</button>

          <button id="btnReload" class="small">é‡æ•´äº‹ä»¶</button>

        </div>

        <div style="margin-top:8px" class="small muted">

          <div style="margin-bottom:4px">ğŸ“¡ è³‡æ–™åŒæ­¥</div>

          <div class="row" style="margin-top:4px">

            <button id="btnSyncToCloud" class="small" style="background:#2196F3">ä¸Šå‚³</button>

            <button id="btnSyncFromCloud" class="small" style="background:#FF9800">ä¸‹è¼‰</button>

            <button id="btnAutoSync" class="small" style="background:#9C27B0">è‡ªå‹•: <span id="autoSyncStatus">é—œ</span></button>

          </div>

          <div id="syncStatus" style="margin-top:4px;font-size:11px;color:#666;min-height:16px"></div>

        </div>

      </div>

    </div>



    <div class="card">

      <h3>èªªæ˜</h3>

      <div class="small">

        - å“¡å·¥å¯æ‹–æ›³è¡Œäº‹æ›†æ–°å¢ <span class="tag">å¯ä¸Šç­ï¼ˆç¶ ï¼‰</span><br>

        - ä¸»ç®¡å¯æ‹–æ›³æ–°å¢ <span class="tag">ç­æ¬¡ï¼ˆè—ï¼‰</span><br>

        - æ–°å¢/ç·¨è¼¯æ™‚æœƒæª¢æŸ¥ï¼šæ˜¯å¦åœ¨ availabilityã€æ˜¯å¦èˆ‡å…¶ä»–ç­æ¬¡è¡çªã€æ˜¯å¦è¶…æ™‚ã€æ˜¯å¦è·¨å¤©ã€‚<br>

        - å“¡å·¥å¯é»ç­æ¬¡ç”³è«‹æ›ç­æˆ–è«‹å‡ï¼ˆRequestsï¼‰ï¼Œä¸»ç®¡å¯åœ¨ Requests é¢æ¿å¯©æ ¸ã€‚

      </div>

    </div>



    <div class="card" id="requestsCard">

      <h3>Requestsï¼ˆæ›ç­/è«‹å‡ï¼‰</h3>

      <div id="reqList" class="small muted">è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹æˆ–é€å‡ºç”³è«‹</div>

    </div>



    <div class="card" id="adminCard" style="display:none">

      <h3>Admin æ“ä½œ</h3>

      <div class="small">ï¼ˆç®¡ç†å“¡å¯åœ¨æ­¤æŸ¥çœ‹æ‰€æœ‰ä½¿ç”¨è€…/å‡ç´š role/å‰µå»ºå¸³è™Ÿï¼‰</div>

      <div id="createUserForm" style="margin-top:12px;padding:8px;background:#f8f9fa;border-radius:6px;display:none">

        <h4 style="margin-top:0;font-size:14px">å‰µå»ºæ–°å¸³è™Ÿ</h4>

        <label style="font-size:12px">å§“å</label><input id="newUserName" style="margin-bottom:6px" />

        <label style="font-size:12px">Email</label><input id="newUserEmail" style="margin-bottom:6px" />

        <label style="font-size:12px">å¯†ç¢¼</label><input id="newUserPassword" type="password" style="margin-bottom:6px" />

        <label style="font-size:12px">è§’è‰²</label>

        <select id="newUserRole" style="margin-bottom:6px">

          <option value="employee">employee</option>

          <option value="manager">manager</option>

          <option value="admin">admin</option>

        </select>

        <div class="row">

          <button id="btnCreateUser" class="small">å‰µå»ºå¸³è™Ÿ</button>

          <button id="btnCancelCreate" class="small">å–æ¶ˆ</button>

        </div>

      </div>

      <div style="margin-top:8px">

        <button id="btnShowCreateUser" class="small" style="margin-bottom:8px">+ å‰µå»ºæ–°å¸³è™Ÿ</button>

      </div>

      <div id="adminUsers" style="margin-top:8px"></div>

    </div>

  </div>



  <div id="calendar" class="card" style="padding:8px">

    <div id="fc"></div>

  </div>

</div>



<!-- App logic -->

<script>

  // ------------------ LocalStorage æ•¸æ“šç®¡ç† ------------------

  const storage = {

    users: 'schedule_users',

    shifts: 'schedule_shifts',

    availabilities: 'schedule_availabilities',

    requests: 'schedule_requests',

    currentUser: 'schedule_current_user'

  };



  function getData(key) {

    const data = localStorage.getItem(key);

    return data ? JSON.parse(data) : [];

  }

  function setData(key, data) {

    localStorage.setItem(key, JSON.stringify(data));

  }

  function generateId() {

    return Date.now().toString(36) + Math.random().toString(36).substr(2);

  }

  // ------------------ Initialize default admin account ------------------

  function initDefaultAdmin(){

    const users = getData(storage.users);

    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ Admin å¸³è™Ÿ

    const adminExists = users.find(u => u.email === 'Admin');

    if(!adminExists){

      const adminUser = {

        id: generateId(),

        name: 'Admin',

        email: 'Admin',

        password: 'Admin',

        role: 'admin',

        createdAt: new Date().toISOString()

      };

      users.push(adminUser);

      setData(storage.users, users);

    }

  }

  // åˆå§‹åŒ–é è¨­ admin å¸³è™Ÿ

  initDefaultAdmin();



  // ------------------ UI å…ƒä»¶ ------------------

  const el = id => document.getElementById(id);

  const btnLogin = el('btnLogin');

  const btnLogout = el('btnLogout'), btnReload = el('btnReload');

  const authForms = el('authForms'), registerForm = el('registerForm'), afterLogin = el('afterLogin');

  const meName = el('meName'), meRole = el('meRole'), userInfo = el('userInfo');

  const reqList = el('reqList'), adminCard = el('adminCard'), adminUsers = el('adminUsers');

  const createUserForm = el('createUserForm'), btnShowCreateUser = el('btnShowCreateUser'), btnCreateUser = el('btnCreateUser'), btnCancelCreate = el('btnCancelCreate');

  const btnExportData = el('btnExportData'), btnImportData = el('btnImportData');

  const syncId = el('syncId'), btnSetSyncId = el('btnSetSyncId'), btnSyncToCloud = el('btnSyncToCloud'), btnSyncFromCloud = el('btnSyncFromCloud'), btnAutoSync = el('btnAutoSync'), autoSyncStatus = el('autoSyncStatus'), syncStatus = el('syncStatus');

  // æª¢æŸ¥å¿…è¦çš„å…ƒç´ æ˜¯å¦å­˜åœ¨

  if(!btnLogin){

    console.error('æ‰¾ä¸åˆ°ç™»å…¥æŒ‰éˆ•å…ƒç´ ');

    alert('ç³»çµ±åˆå§‹åŒ–éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ç™»å…¥æŒ‰éˆ•');

  }



  // ------------------ Auth: register / login ------------------



  // åªæœ‰ä¸»ç®¡å¯ä»¥å‰µå»ºå¸³è™Ÿ

  btnShowCreateUser.onclick = ()=>{

    createUserForm.style.display = createUserForm.style.display === 'none' ? 'block' : 'none';

  };

  btnCancelCreate.onclick = ()=>{

    createUserForm.style.display = 'none';

    el('newUserName').value = '';

    el('newUserEmail').value = '';

    el('newUserPassword').value = '';

    el('newUserRole').value = 'employee';

  };

  btnCreateUser.onclick = ()=>{

    const current = getCurrentUser();

    if(!current || (current.role !== 'admin' && current.role !== 'manager')){

      alert('åªæœ‰ä¸»ç®¡å¯ä»¥å‰µå»ºå¸³è™Ÿ');

      return;

    }

    const name = el('newUserName').value.trim();

    const email = el('newUserEmail').value.trim();

    const pw = el('newUserPassword').value;

    const role = el('newUserRole').value;

    if(!name||!email||!pw) return alert('è«‹å¡«å®Œæ•´');

    const users = getData(storage.users);

    if(users.find(u => u.email === email)) return alert('æ­¤ email å·²è¨»å†Š');

    const newUser = {

      id: generateId(),

      name,

      email,

      password: pw, // ç°¡å–®å­˜å„²ï¼Œå¯¦éš›æ‡‰ç”¨æ‡‰åŠ å¯†

      role: role || 'employee',

      createdAt: new Date().toISOString()

    };

    users.push(newUser);

    setData(storage.users, users);

    alert('å¸³è™Ÿå‰µå»ºæˆåŠŸ');

    el('newUserName').value = '';

    el('newUserEmail').value = '';

    el('newUserPassword').value = '';

    el('newUserRole').value = 'employee';

    createUserForm.style.display = 'none';

    renderAdminUsers();

  };



  if(btnLogin){

    btnLogin.onclick = ()=>{

      try{

        const email = el('email').value.trim(), pw = el('password').value;

        if(!email||!pw) return alert('è«‹å¡«å®Œæ•´');

        const users = getData(storage.users);

        console.log('æ‰€æœ‰ç”¨æˆ¶ï¼š', users);

        const user = users.find(u => u.email === email && u.password === pw);

        console.log('æ‰¾åˆ°çš„ç”¨æˆ¶ï¼š', user);

        if(!user) return alert('ç™»å…¥å¤±æ•—ï¼šemail æˆ–å¯†ç¢¼éŒ¯èª¤');

        setData(storage.currentUser, user);

        el('email').value=''; el('password').value='';

        if(typeof updateAuthUI === 'function'){

          updateAuthUI(user);

        } else {

          console.error('updateAuthUI å‡½æ•¸ä¸å­˜åœ¨');

          alert('ç³»çµ±éŒ¯èª¤ï¼šupdateAuthUI å‡½æ•¸ä¸å­˜åœ¨');

        }

      }catch(e){

        console.error('ç™»å…¥éŒ¯èª¤ï¼š', e);

        alert('ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + e.message);

      }

    };

  } else {

    console.error('ç™»å…¥æŒ‰éˆ•å…ƒç´ ä¸å­˜åœ¨');

  }



  btnLogout.onclick = ()=>{

    localStorage.removeItem(storage.currentUser);

    updateAuthUI(null);

  };



  // ------------------ Calendar init (FullCalendar) ------------------

  let calendar;

  function initCalendar(){ 

    const calendarEl = document.getElementById('fc');

    calendar = new FullCalendar.Calendar(calendarEl, {

      initialView:'timeGridWeek',

      editable: true,

      selectable: true,

      height: 650,

      headerToolbar: { left:'prev,next today', center:'title', right:'timeGridWeek,timeGridDay,listWeek' },

      select: function(info){

        // åˆ¤æ–·è§’è‰²ï¼šå¦‚æœæ˜¯ manager å‰‡å»ºç«‹ shiftï¼Œå¦å‰‡å»ºç«‹ availability

        const user = getCurrentUser();

        if(!user) return alert('è«‹å…ˆç™»å…¥');

        const role = user.role || 'employee';

        if(role === 'manager' || role === 'admin'){

          // å»ºç«‹ shiftï¼ˆå…ˆè©¢å•è¦æ´¾èª°ï¼‰

          const email = prompt('æŒ‡æ´¾çµ¦å“ªä½å“¡å·¥ï¼ˆè¼¸å…¥å“¡å·¥ emailï¼‰ï¼š');

          if(!email) return calendar.unselect();

          // find user by email

          const users = getData(storage.users);

          const target = users.find(u => u.email === email);

          if(!target) { alert('æ‰¾ä¸åˆ°è©²å“¡å·¥'); calendar.unselect(); return; }

          const shift = {

            id: generateId(),

            employeeId: target.id,

            start: info.start.toISOString(),

            end: info.end.toISOString(),

            type: 'normal',

            status: 'active',

            createdBy: user.id,

            createdAt: new Date().toISOString()

          };

          // åœ¨å¯«å…¥å‰åšè¡çªæª¢æŸ¥ï¼ˆclient-sideï¼‰

          const ok = validateShiftBeforeWrite(shift);

          if(!ok) { calendar.unselect(); return; }

          const shifts = getData(storage.shifts);

          shifts.push(shift);

          setData(storage.shifts, shifts);

          loadEvents();

        } else {

          // employee: create availability

          const avail = {

            id: generateId(),

            employeeId: user.id,

            start: info.start.toISOString(),

            end: info.end.toISOString(),

            createdAt: new Date().toISOString()

          };

          const avails = getData(storage.availabilities);

          avails.push(avail);

          setData(storage.availabilities, avails);

          loadEvents();

        }

        calendar.unselect();

      },



      eventDrop: function(info){

        // event moved: update the localStorage data

        const ev = info.event;

        const props = ev.extendedProps;

        if(!props.docId || !props.col) { info.revert(); return; }

        const current = getCurrentUser();

        if(!current) { info.revert(); return; }

        const isManager = current.role === 'manager' || current.role === 'admin';

        // æ¬Šé™æª¢æŸ¥ï¼šå“¡å·¥åªèƒ½ç§»å‹•è‡ªå·±çš„ç­æ¬¡/availabilityï¼Œä¸»ç®¡å¯ä»¥ç§»å‹•ä»»ä½•

        if(!isManager && props.employeeId !== current.id){

          alert('ä½ ç„¡æ¬Šé™ç§»å‹•æ­¤é …ç›®');

          info.revert();

          return;

        }

        // create a temp object representing the new shift and validate

        const newObj = { 

          employeeId: props.employeeId,

          start: ev.start.toISOString(),

          end: ev.end.toISOString()

        };

        if(props.col === 'shifts'){

          const ok = validateShiftBeforeWrite(newObj, props.docId);

          if(!ok){ alert('èª¿æ•´å¾Œè¡çªæˆ–ä¸åœ¨ availability'); info.revert(); return; }

        }

        if(props.col === 'shifts'){

          const shifts = getData(storage.shifts);

          const idx = shifts.findIndex(s => s.id === props.docId);

          if(idx >= 0){

            shifts[idx].start = ev.start.toISOString();

            shifts[idx].end = ev.end.toISOString();

            setData(storage.shifts, shifts);

          }

        } else if(props.col === 'availabilities'){

          const avails = getData(storage.availabilities);

          const idx = avails.findIndex(a => a.id === props.docId);

          if(idx >= 0){

            avails[idx].start = ev.start.toISOString();

            avails[idx].end = ev.end.toISOString();

            setData(storage.availabilities, avails);

          }

        }

      },



      eventResize: function(info){

        const ev = info.event; const props = ev.extendedProps;

        if(!props.docId || !props.col) { info.revert(); return; }

        const current = getCurrentUser();

        if(!current) { info.revert(); return; }

        const isManager = current.role === 'manager' || current.role === 'admin';

        // æ¬Šé™æª¢æŸ¥ï¼šå“¡å·¥åªèƒ½èª¿æ•´è‡ªå·±çš„ç­æ¬¡/availabilityï¼Œä¸»ç®¡å¯ä»¥èª¿æ•´ä»»ä½•

        if(!isManager && props.employeeId !== current.id){

          alert('ä½ ç„¡æ¬Šé™èª¿æ•´æ­¤é …ç›®');

          info.revert();

          return;

        }

        if(props.col === 'shifts'){

          const newObj = { employeeId: props.employeeId, start: ev.start.toISOString(), end: ev.end.toISOString() };

          const ok = validateShiftBeforeWrite(newObj, props.docId);

          if(!ok){ alert('èª¿æ•´å¾Œè¡çªæˆ–ä¸åœ¨ availability'); info.revert(); return; }

        }

        if(props.col === 'shifts'){

          const shifts = getData(storage.shifts);

          const idx = shifts.findIndex(s => s.id === props.docId);

          if(idx >= 0){

            shifts[idx].start = ev.start.toISOString();

            shifts[idx].end = ev.end.toISOString();

            setData(storage.shifts, shifts);

          }

        } else if(props.col === 'availabilities'){

          const avails = getData(storage.availabilities);

          const idx = avails.findIndex(a => a.id === props.docId);

          if(idx >= 0){

            avails[idx].start = ev.start.toISOString();

            avails[idx].end = ev.end.toISOString();

            setData(storage.availabilities, avails);

          }

        }

      },



      eventClick: function(info){

        // é»æ“Šå¯é–‹è©³ç´°æ“ä½œï¼ˆä¾‹å¦‚ï¼šå“¡å·¥å°è‡ªå·±çš„ shift éäº¤ requestï¼‰

        const ev = info.event; const p = ev.extendedProps;

        const current = getCurrentUser();

        if(!current) return alert('è«‹å…ˆç™»å…¥');

        const isManager = current.role === 'manager' || current.role === 'admin';

        // å¦‚æœæ˜¯ shift

        if(p.col === 'shifts'){

          const isOwner = p.employeeId === current.id;

          if(isOwner){

            // å“¡å·¥å°è‡ªå·±çš„ç­æ¬¡ï¼šå¯ä»¥ç”³è«‹æ›ç­ã€è«‹å‡ã€åˆªé™¤ã€ç·¨è¼¯æ™‚é–“

            const action = prompt('è¼¸å…¥ s æ›ç­, l è«‹å‡, e ç·¨è¼¯æ™‚é–“, d åˆªé™¤, æˆ– å–æ¶ˆ');

            if(action === 's'){

              const toEmail = prompt('æ›çµ¦èª°ï¼ˆemailï¼‰ï¼š'); if(!toEmail) return;

              createSwapRequest(p.docId, current.id, toEmail);

            } else if(action === 'l'){

              createLeaveRequest(p.docId, current.id);

            } else if(action === 'e'){

              editShiftTime(p.docId, ev);

            } else if(action === 'd'){

              if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç­æ¬¡ï¼Ÿ')){

                deleteShift(p.docId);

              }

            }

          } else if(isManager){

            // ä¸»ç®¡å°ä»»ä½•ç­æ¬¡ï¼šå¯ä»¥ç·¨è¼¯æ™‚é–“ã€åˆªé™¤

            const action = prompt('è¼¸å…¥ e ç·¨è¼¯æ™‚é–“, d åˆªé™¤, æˆ– å–æ¶ˆ');

            if(action === 'e'){

              editShiftTime(p.docId, ev);

            } else if(action === 'd'){

              if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç­æ¬¡ï¼Ÿ')){

                deleteShift(p.docId);

              }

            }

          } else {

            alert('ä½ ä¸æ˜¯æ­¤ç­æ¬¡çš„å“¡å·¥ï¼Œä¹Ÿç„¡æ¬Šé™æ“ä½œ');

          }

        } else if(p.col === 'availabilities'){

          // availabilityï¼šåªæœ‰æ“æœ‰è€…æˆ–ä¸»ç®¡å¯ä»¥ç·¨è¼¯æ™‚é–“ã€åˆªé™¤

          const isOwner = p.employeeId === current.id;

          if(isOwner || isManager){

            const action = prompt('è¼¸å…¥ e ç·¨è¼¯æ™‚é–“, d åˆªé™¤, æˆ– å–æ¶ˆ');

            if(action === 'e'){

              editAvailabilityTime(p.docId, ev);

            } else if(action === 'd'){

              if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å¯ä¸Šç­æ™‚é–“ï¼Ÿ')){

                deleteAvailability(p.docId);

              }

            }

          } else {

            alert('ä½ ç„¡æ¬Šé™æ“ä½œæ­¤å¯ä¸Šç­æ™‚é–“');

          }

        }

      }

    });

    calendar.render();

  }



  // ------------------ Load events from localStorage ------------------

  function loadEvents(){

    if(!calendar) return;

    const current = getCurrentUser();

    if(!current) return;

    // remove all existing events

    calendar.getEvents().forEach(e => e.remove());

    const users = getData(storage.users);

    const role = current.role || 'employee';

    const isManager = role === 'manager' || role === 'admin';

    // shifts - å“¡å·¥åªèƒ½çœ‹åˆ°è‡ªå·±çš„ï¼Œä¸»ç®¡å¯ä»¥çœ‹åˆ°æ‰€æœ‰

    const shifts = getData(storage.shifts);

    shifts.forEach(d => {

      if(d.status === 'canceled') return;

      // å¦‚æœæ˜¯å“¡å·¥ï¼Œåªé¡¯ç¤ºè‡ªå·±çš„ç­æ¬¡

      if(!isManager && d.employeeId !== current.id) return;

      const employee = users.find(u => u.id === d.employeeId);

      calendar.addEvent({

        id: 's_'+d.id,

        title: '[ç­] ' + (employee ? employee.name : d.employeeId),

        start: d.start,

        end: d.end,

        backgroundColor: '#2196F3',

        borderColor: '#1976D2',

        extendedProps: { col: 'shifts', docId: d.id, employeeId: d.employeeId }

      });

    });



    // availabilities - å“¡å·¥åªèƒ½çœ‹åˆ°è‡ªå·±çš„ï¼Œä¸»ç®¡å¯ä»¥çœ‹åˆ°æ‰€æœ‰

    const avails = getData(storage.availabilities);

    avails.forEach(d => {

      // å¦‚æœæ˜¯å“¡å·¥ï¼Œåªé¡¯ç¤ºè‡ªå·±çš„ availability

      if(!isManager && d.employeeId !== current.id) return;

      const employee = users.find(u => u.id === d.employeeId);

      calendar.addEvent({

        id: 'a_'+d.id,

        title: '[å¯ä¸Šç­]' + (isManager && employee ? ' - ' + employee.name : ''),

        start: d.start,

        end: d.end,

        backgroundColor: '#4CAF50',

        borderColor: '#2E7D32',

        extendedProps: { col: 'availabilities', docId: d.id, employeeId: d.employeeId }

      });

    });

  }



  // ------------------ Utility: find user by email ------------------

  function findUserByEmail(email){

    const users = getData(storage.users);

    return users.find(u => u.email === email) || null;

  }

  function getCurrentUser(){

    const userData = localStorage.getItem(storage.currentUser);

    return userData ? JSON.parse(userData) : null;

  }

  // ------------------ Delete functions ------------------

  function deleteShift(shiftId){

    const shifts = getData(storage.shifts);

    const idx = shifts.findIndex(s => s.id === shiftId);

    if(idx >= 0){

      shifts.splice(idx, 1);

      setData(storage.shifts, shifts);

      loadEvents();

      alert('ç­æ¬¡å·²åˆªé™¤');

    }

  }

  function deleteAvailability(availId){

    const avails = getData(storage.availabilities);

    const idx = avails.findIndex(a => a.id === availId);

    if(idx >= 0){

      avails.splice(idx, 1);

      setData(storage.availabilities, avails);

      loadEvents();

      alert('å¯ä¸Šç­æ™‚é–“å·²åˆªé™¤');

    }

  }

  // ------------------ Edit time functions ------------------

  function editShiftTime(shiftId, event){

    const shifts = getData(storage.shifts);

    const shift = shifts.find(s => s.id === shiftId);

    if(!shift) return;

    const currentStart = new Date(shift.start);

    const currentEnd = new Date(shift.end);

    // æ ¼å¼åŒ–é¡¯ç¤ºç•¶å‰æ™‚é–“ï¼ˆåªé¡¯ç¤ºæ™‚é–“éƒ¨åˆ†ï¼‰

    const formatTime = (date) => {

      const hours = String(date.getHours()).padStart(2, '0');

      const minutes = String(date.getMinutes()).padStart(2, '0');

      return `${hours}:${minutes}`;

    };

    // æç¤ºè¼¸å…¥æ–°æ™‚é–“ï¼ˆåªè¼¸å…¥æ™‚é–“ï¼Œæ—¥æœŸä¿æŒä¸è®Šï¼‰

    const startInput = prompt(`è¼¸å…¥é–‹å§‹æ™‚é–“ï¼ˆæ ¼å¼ï¼šHH:mmï¼Œä¾‹å¦‚ 09:00ï¼‰\nç•¶å‰ï¼š${formatTime(currentStart)}`);

    if(!startInput) return;

    const endInput = prompt(`è¼¸å…¥çµæŸæ™‚é–“ï¼ˆæ ¼å¼ï¼šHH:mmï¼Œä¾‹å¦‚ 17:00ï¼‰\nç•¶å‰ï¼š${formatTime(currentEnd)}`);

    if(!endInput) return;

    // è§£æè¼¸å…¥çš„æ™‚é–“ï¼ˆHH:mm æ ¼å¼ï¼‰

    const parseTime = (timeStr, baseDate) => {

      const timeRegex = /^(\d{1,2}):(\d{2})$/;

      const match = timeStr.match(timeRegex);

      if(!match) return null;

      const hours = parseInt(match[1], 10);

      const minutes = parseInt(match[2], 10);

      if(hours < 0 || hours > 23 || minutes < 0 || minutes > 59) return null;

      const newDate = new Date(baseDate);

      newDate.setHours(hours, minutes, 0, 0);

      return newDate;

    };

    const newStart = parseTime(startInput.trim(), currentStart);

    const newEnd = parseTime(endInput.trim(), currentEnd);

    if(!newStart || !newEnd){

      alert('æ™‚é–“æ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨ HH:mm æ ¼å¼ï¼ˆä¾‹å¦‚ï¼š09:00 æˆ– 14:30ï¼‰');

      return;

    }

    if(newStart >= newEnd){

      alert('é–‹å§‹æ™‚é–“å¿…é ˆæ—©æ–¼çµæŸæ™‚é–“');

      return;

    }

    // é©—è­‰æ–°æ™‚é–“

    const newShiftObj = {

      employeeId: shift.employeeId,

      start: newStart.toISOString(),

      end: newEnd.toISOString()

    };

    const ok = validateShiftBeforeWrite(newShiftObj, shiftId);

    if(!ok) return;

    // æ›´æ–°æ™‚é–“

    const idx = shifts.findIndex(s => s.id === shiftId);

    if(idx >= 0){

      shifts[idx].start = newStart.toISOString();

      shifts[idx].end = newEnd.toISOString();

      setData(storage.shifts, shifts);

      loadEvents();

      alert('æ™‚é–“å·²æ›´æ–°');

    }

  }

  function editAvailabilityTime(availId, event){

    const avails = getData(storage.availabilities);

    const avail = avails.find(a => a.id === availId);

    if(!avail) return;

    const currentStart = new Date(avail.start);

    const currentEnd = new Date(avail.end);

    // æ ¼å¼åŒ–é¡¯ç¤ºç•¶å‰æ™‚é–“ï¼ˆåªé¡¯ç¤ºæ™‚é–“éƒ¨åˆ†ï¼‰

    const formatTime = (date) => {

      const hours = String(date.getHours()).padStart(2, '0');

      const minutes = String(date.getMinutes()).padStart(2, '0');

      return `${hours}:${minutes}`;

    };

    // æç¤ºè¼¸å…¥æ–°æ™‚é–“ï¼ˆåªè¼¸å…¥æ™‚é–“ï¼Œæ—¥æœŸä¿æŒä¸è®Šï¼‰

    const startInput = prompt(`è¼¸å…¥é–‹å§‹æ™‚é–“ï¼ˆæ ¼å¼ï¼šHH:mmï¼Œä¾‹å¦‚ 09:00ï¼‰\nç•¶å‰ï¼š${formatTime(currentStart)}`);

    if(!startInput) return;

    const endInput = prompt(`è¼¸å…¥çµæŸæ™‚é–“ï¼ˆæ ¼å¼ï¼šHH:mmï¼Œä¾‹å¦‚ 17:00ï¼‰\nç•¶å‰ï¼š${formatTime(currentEnd)}`);

    if(!endInput) return;

    // è§£æè¼¸å…¥çš„æ™‚é–“ï¼ˆHH:mm æ ¼å¼ï¼‰

    const parseTime = (timeStr, baseDate) => {

      const timeRegex = /^(\d{1,2}):(\d{2})$/;

      const match = timeStr.match(timeRegex);

      if(!match) return null;

      const hours = parseInt(match[1], 10);

      const minutes = parseInt(match[2], 10);

      if(hours < 0 || hours > 23 || minutes < 0 || minutes > 59) return null;

      const newDate = new Date(baseDate);

      newDate.setHours(hours, minutes, 0, 0);

      return newDate;

    };

    const newStart = parseTime(startInput.trim(), currentStart);

    const newEnd = parseTime(endInput.trim(), currentEnd);

    if(!newStart || !newEnd){

      alert('æ™‚é–“æ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨ HH:mm æ ¼å¼ï¼ˆä¾‹å¦‚ï¼š09:00 æˆ– 14:30ï¼‰');

      return;

    }

    if(newStart >= newEnd){

      alert('é–‹å§‹æ™‚é–“å¿…é ˆæ—©æ–¼çµæŸæ™‚é–“');

      return;

    }

    // æ›´æ–°æ™‚é–“

    const idx = avails.findIndex(a => a.id === availId);

    if(idx >= 0){

      avails[idx].start = newStart.toISOString();

      avails[idx].end = newEnd.toISOString();

      setData(storage.availabilities, avails);

      loadEvents();

      alert('æ™‚é–“å·²æ›´æ–°');

    }

  }



  // ------------------ Requests handling ------------------

  function createSwapRequest(shiftId, fromUid, toEmail){

    const toUser = findUserByEmail(toEmail);

    if(!toUser) return alert('æ‰¾ä¸åˆ°è¦æ›ç­çš„å“¡å·¥');

    const requests = getData(storage.requests);

    requests.push({

      id: generateId(),

      type:'swap',

      shiftId,

      fromEmployee: fromUid,

      toEmployee: toUser.id,

      reason: '',

      status: 'pending',

      managerId: null,

      createdAt: new Date().toISOString()

    });

    setData(storage.requests, requests);

    alert('æ›ç­ç”³è«‹å·²é€å‡º');

    renderRequestsList();

  }

  function createLeaveRequest(shiftId, fromUid){

    const requests = getData(storage.requests);

    requests.push({

      id: generateId(),

      type:'leave',

      shiftId,

      fromEmployee: fromUid,

      toEmployee: null,

      reason: '',

      status:'pending',

      managerId:null,

      createdAt: new Date().toISOString()

    });

    setData(storage.requests, requests);

    alert('è«‹å‡ç”³è«‹å·²é€å‡º');

    renderRequestsList();

  }



  // render requests list

  function renderRequestsList(){

    const current = getCurrentUser();

    if(!current) {

      reqList.innerHTML = '<div class="small muted">è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹æˆ–é€å‡ºç”³è«‹</div>';

      return;

    }

    const requests = getData(storage.requests);

    const users = getData(storage.users);

    let html = '';

    requests.forEach(d => {

      const fromUser = users.find(u => u.id === d.fromEmployee);

      const toUser = d.toEmployee ? users.find(u => u.id === d.toEmployee) : null;

      html += `<div style="padding:6px;border-bottom:1px solid #f0f2f6">

        <div><strong>${d.type.toUpperCase()}</strong> - ${d.status}</div>

        <div class="small">shift: ${d.shiftId}</div>

        <div class="small">from: ${fromUser ? fromUser.name : d.fromEmployee} to: ${toUser ? toUser.name : (d.toEmployee || '-')}</div>

        <div class="small">created: ${new Date(d.createdAt).toLocaleString()}</div>

        <div style="margin-top:6px">`;

      // actions: if current is owner and pending -> can cancel

      if(d.fromEmployee === current.id && d.status === 'pending'){

        html += `<button class="small" onclick="cancelRequest('${d.id}')">å–æ¶ˆ</button> `;

      }

      // if current role is manager/admin and pending -> approve/reject

      if((current.role === 'manager' || current.role === 'admin') && d.status === 'pending'){

        html += `<button class="small" onclick="approveRequest('${d.id}')">æ ¸å‡†</button> `;

        html += `<button class="small danger" onclick="rejectRequest('${d.id}')">æ‹’çµ•</button>`;

      }

      html += `</div></div>`;

    });

    reqList.innerHTML = html || '<div class="small muted">ç›®å‰ç„¡ç”³è«‹</div>';

  }

  function cancelRequest(requestId){

    const requests = getData(storage.requests);

    const idx = requests.findIndex(r => r.id === requestId);

    if(idx >= 0){

      requests[idx].status = 'canceled';

      setData(storage.requests, requests);

      renderRequestsList();

    }

  }

  function approveRequest(requestId){

    const requests = getData(storage.requests);

    const idx = requests.findIndex(r => r.id === requestId);

    if(idx >= 0){

      requests[idx].status = 'approved';

      const req = requests[idx];

      // å¦‚æœæ˜¯æ›ç­ï¼Œæ›´æ–° shift çš„ employeeId

      if(req.type === 'swap' && req.toEmployee){

        const shifts = getData(storage.shifts);

        const shiftIdx = shifts.findIndex(s => s.id === req.shiftId);

        if(shiftIdx >= 0){

          shifts[shiftIdx].employeeId = req.toEmployee;

          setData(storage.shifts, shifts);

          loadEvents();

        }

      }

      setData(storage.requests, requests);

      renderRequestsList();

    }

  }

  function rejectRequest(requestId){

    const requests = getData(storage.requests);

    const idx = requests.findIndex(r => r.id === requestId);

    if(idx >= 0){

      requests[idx].status = 'rejected';

      setData(storage.requests, requests);

      renderRequestsList();

    }

  }

  // å°‡å‡½æ•¸æš´éœ²åˆ°å…¨å±€ä»¥ä¾¿ onclick ä½¿ç”¨

  window.cancelRequest = cancelRequest;

  window.approveRequest = approveRequest;

  window.rejectRequest = rejectRequest;



  // ------------------ Validation before writing a shift ------------------

  // Checks:

  // 1) start/end same day (no cross-day) - optional

  // 2) duration <= 12 hours (configurable)

  // 3) shift is fully contained in at least one availability of that employee

  // 4) no overlapping shifts for that employee

  function validateShiftBeforeWrite(shiftObj, existingDocId=null){

    // shiftObj: { employeeId, start (ISO), end (ISO) }

    const start = new Date(shiftObj.start);

    const end = new Date(shiftObj.end);

    // 1. cross-day check

    if(start.toDateString() !== end.toDateString()){

      if(!confirm('ç­æ¬¡è·¨å¤©ã€‚ç¢ºå®šè¦å…è¨±è·¨å¤©ï¼Ÿï¼ˆæŒ‰å–æ¶ˆæœƒé˜»æ“‹ï¼‰')) return false;

    }

    // 2. duration check

    const hours = (end - start)/1000/3600;

    if(hours > 12) { alert('ç­æ¬¡éé•·ï¼ˆè¶…é 12 å°æ™‚ï¼‰'); return false; } // ä¸Šé™å¯èª¿

    // 3. availability check: find availabilities for employee that include this range

    const avails = getData(storage.availabilities);

    let inside = false;

    avails.forEach(d => {

      if(d.employeeId !== shiftObj.employeeId) return;

      const aStart = new Date(d.start), aEnd = new Date(d.end);

      if(start >= aStart && end <= aEnd) inside = true;

    });

    if(!inside){

      if(!confirm('æ­¤ç­æ¬¡ä¸åœ¨å“¡å·¥çš„ availability ç¯„åœå…§ã€‚ä»ç„¶è¦æ’æ­¤ç­å—ï¼Ÿï¼ˆå–æ¶ˆæœƒé˜»æ“‹ï¼‰')) return false;

    }

    // 4. overlapping shifts

    const shifts = getData(storage.shifts);

    for(const sdoc of shifts){

      if(existingDocId && sdoc.id === existingDocId) continue;

      if(sdoc.employeeId !== shiftObj.employeeId) continue;

      if(sdoc.status === 'canceled') continue;

      const sStart = new Date(sdoc.start), sEnd = new Date(sdoc.end);

      if(start < sEnd && end > sStart){

        alert('ç™¼ç¾é‡ç–Šç­æ¬¡ï¼Œç„¡æ³•æ’ç­');

        return false;

      }

    }

    return true;

  }



  // ------------------ Update Auth UI ------------------

  function updateAuthUI(user){

    if(user){

      meName.textContent = user.name || user.email;

      meRole.textContent = user.role || 'employee';

      userInfo.textContent = `${meName.textContent}ï¼ˆ${meRole.textContent}ï¼‰`;

      authForms.style.display='none'; registerForm.style.display='none'; afterLogin.style.display='block';

      adminCard.style.display = user.role === 'admin' ? 'block' : 'none';

      // é¡¯ç¤º/éš±è—åŒ¯å‡ºåŒ¯å…¥æŒ‰éˆ•ï¼ˆåªæœ‰ä¸»ç®¡å¯ä»¥çœ‹åˆ°ï¼‰

      const isManager = user.role === 'admin' || user.role === 'manager';

      if(btnExportData) btnExportData.style.display = isManager ? 'block' : 'none';

      if(btnImportData) btnImportData.style.display = isManager ? 'block' : 'none';

      // init calendar after login

      if(!calendar) initCalendar();

      loadEvents();

      renderRequestsList();

      // render admin users if admin

      if(user.role === 'admin') renderAdminUsers();

    } else {

      meName.textContent=''; meRole.textContent=''; userInfo.textContent='';

      authForms.style.display='block'; registerForm.style.display='none'; afterLogin.style.display='none';

      adminCard.style.display='none';

      if(calendar) calendar.destroy(); calendar = null;

    }

  }

  // æª¢æŸ¥æ˜¯å¦æœ‰å·²ç™»å…¥çš„ä½¿ç”¨è€…

  const currentUser = getCurrentUser();

  if(currentUser) updateAuthUI(currentUser);



  // ------------------ Admin: list users ------------------

  function renderAdminUsers(){

    const users = getData(storage.users);

    adminUsers.innerHTML = '';

    users.forEach(d => {

      const div = document.createElement('div');

      div.style.padding='6px'; div.style.borderBottom='1px solid #f0f2f6';

      div.innerHTML = `<div><strong>${d.name}</strong> <span class="small muted">${d.email}</span></div>

        <div class="small">role: ${d.role}</div>`;

      const btnContainer = document.createElement('div');

      btnContainer.style.marginTop='6px';

      btnContainer.style.display='flex';

      btnContainer.style.gap='6px';

      // add upgrade button

      if(d.role !== 'manager' && d.role !== 'admin'){

        const upgradeBtn = document.createElement('button');

        upgradeBtn.textContent = 'å‡ç´šç‚º manager';

        upgradeBtn.onclick = ()=>{

          const users = getData(storage.users);

          const idx = users.findIndex(u => u.id === d.id);

          if(idx >= 0){

            users[idx].role = 'manager';

            setData(storage.users, users);

            // æ›´æ–°ç•¶å‰ä½¿ç”¨è€…è³‡æ–™ï¼ˆå¦‚æœæ˜¯è‡ªå·±ï¼‰

            const current = getCurrentUser();

            if(current && current.id === d.id){

              current.role = 'manager';

              setData(storage.currentUser, current);

              updateAuthUI(current);

            }

            alert('å·²å‡ç´š');

            renderAdminUsers();

          }

        };

        btnContainer.appendChild(upgradeBtn);

      }

      // add delete button (ä¸èƒ½åˆªé™¤è‡ªå·±)

      const current = getCurrentUser();

      if(current && current.id !== d.id){

        const deleteBtn = document.createElement('button');

        deleteBtn.textContent = 'åˆªé™¤å¸³è™Ÿ';

        deleteBtn.className = 'danger';

        deleteBtn.onclick = ()=>{

          if(confirm(`ç¢ºå®šè¦åˆªé™¤å¸³è™Ÿã€Œ${d.name}ï¼ˆ${d.email}ï¼‰ã€ï¼Ÿ\næ­¤æ“ä½œå°‡åŒæ™‚åˆªé™¤è©²ç”¨æˆ¶çš„æ‰€æœ‰ç­æ¬¡ã€å¯ä¸Šç­æ™‚é–“å’Œç”³è«‹è¨˜éŒ„ã€‚`)){

            deleteUserAccount(d.id);

          }

        };

        btnContainer.appendChild(deleteBtn);

      }

      if(btnContainer.children.length > 0){

        div.appendChild(btnContainer);

      }

      adminUsers.appendChild(div);

    });

  }

  // ------------------ Delete user account ------------------

  function deleteUserAccount(userId){

    const current = getCurrentUser();

    if(!current || (current.role !== 'admin' && current.role !== 'manager')){

      alert('ç„¡æ¬Šé™åˆªé™¤å¸³è™Ÿ');

      return;

    }

    // ä¸èƒ½åˆªé™¤è‡ªå·±

    if(current.id === userId){

      alert('ä¸èƒ½åˆªé™¤è‡ªå·±çš„å¸³è™Ÿ');

      return;

    }

    // åˆªé™¤ç”¨æˆ¶

    const users = getData(storage.users);

    const userIdx = users.findIndex(u => u.id === userId);

    if(userIdx < 0){

      alert('æ‰¾ä¸åˆ°è©²ç”¨æˆ¶');

      return;

    }

    users.splice(userIdx, 1);

    setData(storage.users, users);

    // åˆªé™¤è©²ç”¨æˆ¶çš„æ‰€æœ‰ç­æ¬¡

    const shifts = getData(storage.shifts);

    const filteredShifts = shifts.filter(s => s.employeeId !== userId);

    setData(storage.shifts, filteredShifts);

    // åˆªé™¤è©²ç”¨æˆ¶çš„æ‰€æœ‰å¯ä¸Šç­æ™‚é–“

    const avails = getData(storage.availabilities);

    const filteredAvails = avails.filter(a => a.employeeId !== userId);

    setData(storage.availabilities, filteredAvails);

    // åˆªé™¤è©²ç”¨æˆ¶ç›¸é—œçš„ç”³è«‹ï¼ˆä½œç‚ºç”³è«‹è€…æˆ–æ¥æ”¶è€…ï¼‰

    const requests = getData(storage.requests);

    const filteredRequests = requests.filter(r => r.fromEmployee !== userId && r.toEmployee !== userId);

    setData(storage.requests, filteredRequests);

    // å¦‚æœè©²ç”¨æˆ¶æ­£åœ¨ç™»å…¥ï¼Œå¼·åˆ¶ç™»å‡º

    const loggedInUser = getCurrentUser();

    if(loggedInUser && loggedInUser.id === userId){

      localStorage.removeItem(storage.currentUser);

      updateAuthUI(null);

    }

    // é‡æ–°è¼‰å…¥äº‹ä»¶å’Œæ›´æ–° UI

    loadEvents();

    renderRequestsList();

    renderAdminUsers();

    alert('å¸³è™ŸåŠç›¸é—œè³‡æ–™å·²åˆªé™¤');

  }



  // ------------------ Cloud Sync Functions ------------------

  const SYNC_STORAGE_KEY = 'schedule_sync_data';

  let autoSyncInterval = null;

  let isAutoSyncEnabled = false;

  // ä½¿ç”¨å›ºå®šçš„åŒæ­¥ keyï¼ˆæ‰€æœ‰è£ç½®å…±äº«ï¼‰

  const SYNC_KEY = 'schedule_system_sync';

  // ä¸Šå‚³åˆ°é›²ç«¯ï¼ˆå³æ™‚åŒæ­¥ï¼‰

  async function syncToCloud(){

    const current = getCurrentUser();

    if(!current || (current.role !== 'admin' && current.role !== 'manager')){

      alert('åªæœ‰ä¸»ç®¡å¯ä»¥åŒæ­¥è³‡æ–™');

      return;

    }

    try{

      if(syncStatus){

        syncStatus.textContent = 'â³ ä¸Šå‚³ä¸­...';

        syncStatus.style.color = '#2196F3';

      }

      const data = {

        users: getData(storage.users),

        shifts: getData(storage.shifts),

        availabilities: getData(storage.availabilities),

        requests: getData(storage.requests),

        syncDate: new Date().toISOString()

      };

      // å­˜å„²åˆ°æœ¬åœ°ï¼ˆä¸»è¦å­˜å„²ï¼‰

      localStorage.setItem(SYNC_KEY, JSON.stringify(data));

      localStorage.setItem(`${SYNC_KEY}_timestamp`, Date.now().toString());

      // å˜—è©¦ä¸Šå‚³åˆ°é›²ç«¯ï¼ˆå¦‚æœå¯ç”¨ï¼‰

      try{

        // ä½¿ç”¨ç°¡å–®çš„å…¬é–‹ JSON å­˜å„²æœå‹™

        // æ³¨æ„ï¼šå¯¦éš›éƒ¨ç½²åˆ° GitHub Pages æ™‚ï¼Œå¯ä»¥æ›¿æ›ç‚ºæ‚¨çš„å¾Œç«¯ API

        const publicApiUrl = `https://api.jsonbin.io/v3/b`;

        const response = await fetch(publicApiUrl, {

          method: 'POST',

          headers: {

            'Content-Type': 'application/json',

            'X-Bin-Name': SYNC_KEY,

            'X-Bin-Private': 'false'

          },

          body: JSON.stringify(data)

        });

        if(response.ok){

          const result = await response.json();

          localStorage.setItem(`${SYNC_KEY}_binId`, result.metadata.id);

        }

      }catch(err){

        console.log('é›²ç«¯ä¸Šå‚³å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å­˜å„²ï¼š', err);

      }

      if(syncStatus){

        syncStatus.textContent = 'âœ“ å·²åŒæ­¥';

        syncStatus.style.color = '#4CAF50';

        setTimeout(()=>{ if(syncStatus) syncStatus.textContent = ''; }, 2000);

      }

    }catch(err){

      console.error('åŒæ­¥éŒ¯èª¤ï¼š', err);

      if(syncStatus){

        syncStatus.textContent = 'âœ— å¤±æ•—';

        syncStatus.style.color = '#f44336';

        setTimeout(()=>{ if(syncStatus) syncStatus.textContent = ''; }, 3000);

      }

    }

  }

  // å¾é›²ç«¯ä¸‹è¼‰ï¼ˆå³æ™‚åŒæ­¥ï¼‰

  async function syncFromCloud(){

    const current = getCurrentUser();

    if(!current || (current.role !== 'admin' && current.role !== 'manager')){

      alert('åªæœ‰ä¸»ç®¡å¯ä»¥åŒæ­¥è³‡æ–™');

      return;

    }

    try{

      if(syncStatus){

        syncStatus.textContent = 'â³ ä¸‹è¼‰ä¸­...';

        syncStatus.style.color = '#2196F3';

      }

      // å…ˆå˜—è©¦å¾é›²ç«¯ç²å–

      let data = null;

      const binId = localStorage.getItem(`${SYNC_KEY}_binId`);

      if(binId){

        try{

          const apiUrl = `https://api.jsonbin.io/v3/b/${binId}/latest`;

          const response = await fetch(apiUrl);

          if(response.ok){

            const result = await response.json();

            data = result.record;

            // æ›´æ–°æœ¬åœ°å‚™ä»½

            if(data){

              localStorage.setItem(SYNC_KEY, JSON.stringify(data));

              localStorage.setItem(`${SYNC_KEY}_timestamp`, Date.now().toString());

            }

          }

        }catch(err){

          console.log('å¾é›²ç«¯ç²å–å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å‚™ä»½ï¼š', err);

        }

      }

      // å¦‚æœé›²ç«¯ç²å–å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å‚™ä»½

      if(!data){

        const dataStr = localStorage.getItem(SYNC_KEY);

        if(!dataStr){

          throw new Error('æ‰¾ä¸åˆ°åŒæ­¥è³‡æ–™ï¼Œè«‹å…ˆä¸Šå‚³');

        }

        data = JSON.parse(dataStr);

      }

      if(!data.users || !data.shifts || !data.availabilities || !data.requests){

        throw new Error('è³‡æ–™æ ¼å¼éŒ¯èª¤');

      }

      // ä¿ç•™ç•¶å‰ç™»å…¥ç”¨æˆ¶

      const currentUser = getCurrentUser();

      const currentUserId = currentUser ? currentUser.id : null;

      // åŒ¯å…¥è³‡æ–™

      setData(storage.users, data.users);

      setData(storage.shifts, data.shifts);

      setData(storage.availabilities, data.availabilities);

      setData(storage.requests, data.requests);

      // æ¢å¾©ç™»å…¥ç‹€æ…‹

      if(currentUserId){

        const users = getData(storage.users);

        const user = users.find(u => u.id === currentUserId);

        if(user){

          setData(storage.currentUser, user);

        }

      }

      // é‡æ–°è¼‰å…¥

      loadEvents();

      renderRequestsList();

      if(current && (current.role === 'admin' || current.role === 'manager')){

        renderAdminUsers();

      }

      if(syncStatus){

        syncStatus.textContent = 'âœ“ å·²åŒæ­¥';

        syncStatus.style.color = '#4CAF50';

        setTimeout(()=>{ if(syncStatus) syncStatus.textContent = ''; }, 2000);

      }

    }catch(err){

      console.error('åŒæ­¥éŒ¯èª¤ï¼š', err);

      if(syncStatus){

        syncStatus.textContent = 'âœ— å¤±æ•—';

        syncStatus.style.color = '#f44336';

        setTimeout(()=>{ if(syncStatus) syncStatus.textContent = ''; }, 3000);

      }

    }

  }

  // è‡ªå‹•åŒæ­¥ï¼ˆå³æ™‚ï¼‰

  function toggleAutoSync(){

    const current = getCurrentUser();

    if(!current || (current.role !== 'admin' && current.role !== 'manager')){

      alert('åªæœ‰ä¸»ç®¡å¯ä»¥å•Ÿç”¨è‡ªå‹•åŒæ­¥');

      return;

    }

    isAutoSyncEnabled = !isAutoSyncEnabled;

    if(isAutoSyncEnabled){

      // æ¯ 5 ç§’è‡ªå‹•åŒæ­¥ä¸€æ¬¡ï¼ˆæ›´é »ç¹ï¼‰

      autoSyncInterval = setInterval(async ()=>{

        await syncFromCloud(); // å…ˆä¸‹è¼‰

        await syncToCloud(); // å†ä¸Šå‚³

      }, 5000);

      if(autoSyncStatus) autoSyncStatus.textContent = 'é–‹';

      if(syncStatus){

        syncStatus.textContent = 'è‡ªå‹•åŒæ­¥å·²é–‹å•Ÿ';

        syncStatus.style.color = '#4CAF50';

        setTimeout(()=>{ if(syncStatus) syncStatus.textContent = ''; }, 2000);

      }

    } else {

      if(autoSyncInterval){

        clearInterval(autoSyncInterval);

        autoSyncInterval = null;

      }

      if(autoSyncStatus) autoSyncStatus.textContent = 'é—œ';

      if(syncStatus){

        syncStatus.textContent = 'è‡ªå‹•åŒæ­¥å·²é—œé–‰';

        syncStatus.style.color = '#666';

        setTimeout(()=>{ if(syncStatus) syncStatus.textContent = ''; }, 2000);

      }

    }

  }

  // ------------------ Data Export/Import ------------------

  function exportData(){

    const current = getCurrentUser();

    if(!current || (current.role !== 'admin' && current.role !== 'manager')){

      alert('åªæœ‰ä¸»ç®¡å¯ä»¥åŒ¯å‡ºè³‡æ–™');

      return;

    }

    const data = {

      users: getData(storage.users),

      shifts: getData(storage.shifts),

      availabilities: getData(storage.availabilities),

      requests: getData(storage.requests),

      exportDate: new Date().toISOString()

    };

    const dataStr = JSON.stringify(data, null, 2);

    const dataBlob = new Blob([dataStr], { type: 'application/json' });

    const url = URL.createObjectURL(dataBlob);

    const link = document.createElement('a');

    link.href = url;

    link.download = `æ’ç­ç³»çµ±è³‡æ–™_${new Date().toISOString().split('T')[0]}.json`;

    document.body.appendChild(link);

    link.click();

    document.body.removeChild(link);

    URL.revokeObjectURL(url);

    alert('è³‡æ–™å·²åŒ¯å‡ºï¼è«‹å°‡æ­¤æª”æ¡ˆåˆ†äº«çµ¦å…¶ä»–è£ç½®ä½¿ç”¨ã€‚');

  }

  function importData(){

    const current = getCurrentUser();

    if(!current || (current.role !== 'admin' && current.role !== 'manager')){

      alert('åªæœ‰ä¸»ç®¡å¯ä»¥åŒ¯å…¥è³‡æ–™');

      return;

    }

    if(!confirm('åŒ¯å…¥è³‡æ–™å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) return;

    const input = document.createElement('input');

    input.type = 'file';

    input.accept = '.json';

    input.onchange = (e)=>{

      const file = e.target.files[0];

      if(!file) return;

      const reader = new FileReader();

      reader.onload = (e)=>{

        try{

          const data = JSON.parse(e.target.result);

          if(!data.users || !data.shifts || !data.availabilities || !data.requests){

            alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤');

            return;

          }

          // ä¿ç•™ç•¶å‰ç™»å…¥ç”¨æˆ¶ï¼Œé¿å…åŒ¯å…¥å¾Œè¢«ç™»å‡º

          const currentUser = getCurrentUser();

          const currentUserId = currentUser ? currentUser.id : null;

          // åŒ¯å…¥è³‡æ–™

          setData(storage.users, data.users);

          setData(storage.shifts, data.shifts);

          setData(storage.availabilities, data.availabilities);

          setData(storage.requests, data.requests);

          // å¦‚æœç•¶å‰ç”¨æˆ¶é‚„åœ¨ï¼Œæ¢å¾©ç™»å…¥ç‹€æ…‹

          if(currentUserId){

            const users = getData(storage.users);

            const user = users.find(u => u.id === currentUserId);

            if(user){

              setData(storage.currentUser, user);

            }

          }

          // é‡æ–°è¼‰å…¥

          loadEvents();

          renderRequestsList();

          if(current && (current.role === 'admin' || current.role === 'manager')){

            renderAdminUsers();

          }

          alert('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼');

        }catch(err){

          console.error('åŒ¯å…¥éŒ¯èª¤ï¼š', err);

          alert('åŒ¯å…¥å¤±æ•—ï¼š' + err.message);

        }

      };

      reader.readAsText(file);

    };

    input.click();

  }

  // ------------------ start ------------------

  // åˆå§‹åŒ–æŒ‰éˆ•äº‹ä»¶

  if(btnReload){

    btnReload.onclick = ()=>{

      loadEvents();

      alert('äº‹ä»¶å·²é‡æ–°è¼‰å…¥');

    };

  }

  if(btnSyncToCloud){

    btnSyncToCloud.onclick = syncToCloud;

  }

  if(btnSyncFromCloud){

    btnSyncFromCloud.onclick = syncFromCloud;

  }

  if(btnAutoSync){

    btnAutoSync.onclick = toggleAutoSync;

  }

  // å¦‚æœå·²ç™»å…¥ï¼Œåˆå§‹åŒ–æ—¥æ›†

  if(getCurrentUser()){

    initCalendar();

  }



</script>



</body>

</html>

